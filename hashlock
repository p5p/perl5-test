From owt1@cornell.edu  Thu Oct 23 19:12:11 1997
Received: from oxmail4.ox.ac.uk (oxmail4.ox.ac.uk [163.1.2.33]) by sable.ox.ac.uk (1.2/8.8.3) with SMTP id TAA04852 for <mbeattie@sable.ox.ac.uk>; Thu, 23 Oct 1997 19:12:11 +0100 (BST)
Received: from cu-dialup-1702.cit.cornell.edu by oxmail4 with SMTP (PP);
          Thu, 23 Oct 1997 19:12:00 +0100
Received: (qmail 14848 invoked by uid 504); 23 Oct 1997 18:13:55 -0000
To: perl5-porters@perl.org
Cc: Malcolm Beattie <mbeattie@sable.ox.ac.uk>
Subject: [perl5.004_53; patch] Another hash-locking fix
References: <lzafg37nso.fsf@cu-dialup-1722.cit.cornell.edu> <lz90vn6ovd.fsf@cu-dialup-1722.cit.cornell.edu>
From: Owen Taylor <owt1@cornell.edu>
Date: 23 Oct 1997 14:13:55 -0400
In-Reply-To: Owen Taylor's message of 21 Oct 1997 12:51:34 -0400
Message-ID: <lzpvowfiu4.fsf_-_@cu-dialup-0803.cit.cornell.edu>
Lines: 54
X-Mailer: Gnus v5.5/Emacs 20.2
Status: RO


The following:

  my %hash;

  $hash{a} = 1;
  { lock \%hash }

  delete $hash{a};

produces an assertion failure at mg.c, line 46. This happens because
hv_delete and hv_delete_ent don't expect 'm' magic.

Regards,
                                        Owen

*** /usr/home/owen/store/perl5.004_53.orig/hv.c	Thu Oct 16 12:45:53 1997
--- perl5.004_53/hv.c	Thu Oct 23 02:08:42 1997
***************
*** 390,396 ****
  
      if (!hv)
  	return Nullsv;
!     if (SvRMAGICAL(hv)) {
  	sv = *hv_fetch(hv, key, klen, TRUE);
  	mg_clear(sv);
  	if (mg_find(sv, 's')) {
--- 414,421 ----
  
      if (!hv)
  	return Nullsv;
!     if (SvRMAGICAL(hv) && (SvMAGIC(hv)->mg_moremagic
! 			   || SvMAGIC(hv)->mg_type != 'm')) {
  	sv = *hv_fetch(hv, key, klen, TRUE);
  	mg_clear(sv);
  	if (mg_find(sv, 's')) {
***************
*** 451,457 ****
      
      if (!hv)
  	return Nullsv;
!     if (SvRMAGICAL(hv)) {
  	entry = hv_fetch_ent(hv, keysv, TRUE, hash);
  	sv = HeVAL(entry);
  	mg_clear(sv);
--- 476,483 ----
      
      if (!hv)
  	return Nullsv;
!     if (SvRMAGICAL(hv) && (SvMAGIC(hv)->mg_moremagic
! 			   || SvMAGIC(hv)->mg_type != 'm')) {
  	entry = hv_fetch_ent(hv, keysv, TRUE, hash);
  	sv = HeVAL(entry);
  	mg_clear(sv);

